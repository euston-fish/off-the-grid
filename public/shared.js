'use strict';var f;Array.i=function(...a){return(a[0]||[]).map((b,c)=>a.map((a)=>a[c]))};f=Array.prototype;f.i=function(...a){return Array.i(this,...a)};f.C=function(){return this.reduce((a,b)=>a+b,0)};f.product=function(){return this.reduce((a,b)=>a*b,1)};f.add=function(...a){return this.i(...a).map((a)=>a.C())};f.v=function(){return this.map((a)=>-a)};f.sub=function(a){return this.add(a.v())};f.scale=function(a){return this.map((b)=>b*a)};f.h=function(...a){return Array.h(this,...a)};
f.u=function(){return this.reduce((a,b)=>a.concat(b),[])};Array.h=function(a,...b){return void 0===a?[[]]:a.map((a)=>Array.h(...b).map((b)=>[a,...b])).u()};Array.prototype.s=function(){return Array(Math.ceil(this.length/2)).fill().map((a,b)=>this.slice(2*b,2*b+2))};Number.prototype.b=function(){return(this%1024+1024)%1024};const h=([a,b],[c,d])=>[a+c,b+d],n=([a,b])=>[-a,-b],r=([a,b])=>Math.sqrt(a*a+b*b),v=([a,b],[c,d])=>{var [k,e]=[0,0];return k<=a&&a<c&&e<=b&&b<d},w=(a,b)=>b.add(a).scale(.03125).map(Math.floor);function x(a,b,c,d){this.source=a;this.f=b;this.offset=c||[0,0];this.size=d||h(b,n(this.offset))}f=x.prototype;f.keys=function*(){for(let a=0;a<this.size[0];a++)for(let b=0;b<this.size[1];b++)yield[a,b]};function z([a,b],[,c]){return a*c+b}f.get=function(a){if(!(0>a[0]||a[0]>this.size[0]||0>a[1]||a[1]>this.size[1]))return this.source[z(h(a,this.offset),this.f)]};f.set=function(a,b){0>a[0]||a[0]>this.size[0]||0>a[1]||a[1]>this.size[1]||(this.source[z(h(a,this.offset),this.f)]=b)};
f.update=function(a,b){this.set(a,b(this.get(a),a))};f.shift=function(a){return new x(this.source,this.f,h(this.offset,a),h(this.size,n(a)))};f.B=function(a){return new x(this.source,this.f,this.offset,a)};f.window=function(a,b){return this.shift(a).B(b)};f.toJSON=function(){return Array.from(this.keys()).map((a)=>this.get(a))};function A(a){this.m=a;this.origin=[0,0];this.size=[0,0];this.data=[]}let B=([a,b],[,c])=>a*c+b;A.prototype.get=function(a){return this.data[B(h(a,n(this.origin)),this.size)]};A.prototype.j=function(a,b,c){for(let d=0;d<c[0];d++)for(let k=0;k<c[1];k++){let e=[d,k],p=h(h(e,b),n(this.origin));v(p,this.size)&&(this.data[B(p,this.size)]=a[B(e,c)])}};A.prototype.c=function(a,b){let c=this.data,d=this.origin,k=this.size;this.data=Array(b[0]*b[1]).fill();this.origin=a;this.size=b;this.j(c,d,k)};
A.prototype.update=function(a,b){a=a||this.origin;b=b||this.size;return fetch(`${this.m}/${a[0]}/${a[1]}/${b[0]}/${b[1]}/`).then((a)=>a.json()).then((c)=>this.j(c,a,b))};const C=Uint8Array.from("0061736d01000000011f0660027f7f017d60047f7f7f7f006000006000017c60027d7d017d6000017f02190203656e760672616e646f6d000303656e7604706f7766000403080700010204020502050401009101073805066d656d6f7279020004696e69740004047469636b00060761646472657373000713727573745f65685f706572736f6e616c69747900080a970b072b002000410a744180f83f71200141ff07717241027422004180086a2a0200200041808880026a2a0200920bf30101037d200020011002200220031002932204430000000020044300000000601b2106430000803f21042000410a744180f83f71200141ff077172410274220041808880026a22012a0200220543000000005e4504402005430000404095430000803f922204430000803f2004430000803f5d1b2204430000000020044300000000601b21040b20012005200620049443cdcccc3e942204933802002002410a744180f83f71200341ff077172410274220241808880026a220320032a020020049238020020004180086a220320032a02002004436f12833a9422049338020020024180086a2202200420022a0200923802000bc00203027f027d017c41807e2100024003402000450d01200041818a80046a027f41001000440000000000007040a2220444000000000000f0416320044400000000000000006671450d001a2004ab0b3a0000200041016a21000c000b000b418080807e2100024003402000450d01200041808880026a200141ff0771b22202430000003e942001410a76b22203430000003e941005430000003f92433333333f942002430000804492430000c041952003430000c041951005430000803f92436666e63f94922002430000004592430000803c942003430000803c941005430000803f9243cdcc4c3f949243abaa2a4294380200200041046a2100200141016a21010c000b000b418080800221000240034020004180808004460d0120004180086a1000b6430000704194430000a0c092380200200041046a21000c000b000b0bb70502047f067d027f4100430000803f43000000002000200020019243ae67bb3e9422082000928e2206200620082001928e220892438c65583e94220793932200200120082007939322015e22031b2207430000804f5d200743000000006071450d001a2007a90b027f41808080807820068b430000004f5d450d001a2006a80b22026a027f41004300000000430000803f20031b2206430000804f5d200643000000006071450d001a2006a90b027f41808080807820088b430000004f5d450d001a2008a80b22036a41ff017141818880046a2d00006a41ff017141818880046a2d0000410c7021042001200693438c65583e9221062000200793438c65583e922108200143000080bf922107200043000080bf9221092002200341016a41ff017141818880046a2d00006a41016a41ff017141818880046a2d0000410c702105430000003f200020009493200120019493220a43000000005d450440200341ff017141818880046a2d000020026a41ff017141818880046a2d00002102200a4300008040100120002002410c7041036c41828a80046a22022f0000200241026a2d0000411074722202411874411875b29420012002411074411875b2949294210b0b2007438c65d83e9221002009438c65d83e9221014300000000210743000000002109430000003f200820089493200620069493220a43000000005d450440200a430000804010012008200441ff017141036c41828a80046a22022f0000200241026a2d0000411074722202411874411875b29420062002411074411875b294929421090b430000003f200120019493200020009493220643000000005d4504402006430000804010012001200541ff017141036c41828a80046a22022f0000200241026a2d0000411074722202411874411875b29420002002411074411875b294929421070b200b2009922007924300008c42940b6f01057f024003402000418008460d01200041016a2102410021014180082104024003402004450d012000200120022001100320022001200020011003200020012000200141016a22031003200020032000200110032004417f6a2104200321010c000b000b200221000c000b000b0b05004180080b0300010b0b2d010041828a80040b24010100ff010001ff00ffff00010001ff00010100ffff00ff00010100ff010001ff00ffff".split("").s().map(([a,
b])=>parseInt(a+b,16)));function D(){var a=new WebAssembly.Module(C);this.a=new WebAssembly.Instance(a,{env:{random:Math.random,log:(a)=>console.log("from rust with love: "+a),logf:(a)=>console.log("from rust with love: "+a),powf:Math.pow}});this.a.exports.init();a=this.a.exports.memory;this.g=this.a.exports.address();console.log("address: "+this.g);this.D=new x(new Float32Array(a.buffer,this.g,1048576),[1024,1024]);this.G=new x(new Float32Array(a.buffer,this.g+4194304,1048576),[1024,1024])}D.prototype.F=function(){this.a.exports.tick()};function E(){let a=new D,b=a.D,c=a.G,d=()=>{let b=new Date;a.F();console.log("tick time: "+(new Date-b));setTimeout(d,1E3)};d();return{io:(a)=>{a.on("disconnect",()=>{console.log("Disconnected: "+a.id)});console.log("Connected: "+a.id)},"terrain/:col/:row/:width/:height":(a,c)=>{let [d,k,g,e]=["col","row","width","height"].map((b)=>parseInt(a.params[b])),m=[];for(let a=d;a<d+g;a++)for(let c=k;c<k+e;c++)m.push(b.get([a.b(),c.b()]));c.json(m)},"water/:col/:row/:width/:height":(a,b)=>{let [d,k,g,e]=
["col","row","width","height"].map((b)=>parseInt(a.params[b])),m=[];for(let a=d;a<d+g;a++)for(let b=k;b<k+e;b++)m.push(c.get([a.b(),b.b()]));b.json(m)},"place_instruction/:x/:y/:type":(a,b)=>{let [c,d,g]=["x","y","type"].map((b)=>parseInt(a.params[b]));console.log(`Placing ${g} at ${c},${d}`);b.json({ok:"sick"})}}};let F,G=null,H=[];function I(a,b){this.name=a;this.code=b;a=document.createElement("div");a.innerText=this.name;a.className="instruction";let c=this;a.addEventListener("click",()=>{let a=c.w;H.forEach((a)=>a.setActive(!1));c.setActive(!a);G&&G(a?null:c)});this.node=a;H.push(this)}f=I.prototype;f.setActive=function(a){this.w=a;this.node.className="instruction"+(a?" active":"")};f.l=function(){F.appendChild(this.node)};
f.remove=function(){F.removeChild(this.node);let a=H.indexOf(this.node);-1<a&&H.splice(a,1)};f.A=function(){this.className="instruction placed"};f.o=function({water:a}){return 0>a};const J=["THingness","Stuffyness","Moredoodles","Deadliness"];"undefined"!==eval("typeof window")?window.addEventListener("load",()=>{let a=new A("/terrain"),b=new A("/water"),c;c=io({H:!1,transports:["websocket"]});let d=[0,0],k=null,e=null,p=[-1,-1],q=null,g=document.getElementById("c"),t=g.getContext("2d"),m=()=>{g.width=window.innerWidth;g.height=window.innerHeight;let c=w(d,[0,0]);var l=w(d,[g.width,g.height]);l=h(l,n(c));a.c(h(c,n([5,5])),h(l,[10,10]));b.c(h(c,n([5,5])),h(l,[10,10]))};window.addEventListener("resize",m);m();g.addEventListener("mousedown",
(a)=>{k=e=[a.x,a.y]});g.addEventListener("mouseup",()=>{if(5>r(h(e,n(k)))&&q){let [a,b]=w(d,e);q.A();let c=q;q=null;fetch(`/place_instruction/${a}/${b}/${c.code}`).then(()=>c.remove())}e=null});g.addEventListener("mousemove",(c)=>{p=[c.x,c.y];if(e){c=[c.x,c.y].sub(e);d=d.sub(c);e=p;c=w(d,[0,0]);var l=w(d,[g.width,g.height]);l=h(l,n(c));a.c(h(c,n([5,5])),h(l,[10,10]));b.c(h(c,n([5,5])),h(l,[10,10]))}window.requestAnimationFrame(u)});F=document.getElementById("toolbar");G=(a)=>{q=a};setInterval(()=>
{if(5>H.length){var a=Math.floor(Math.random()*J.length);a=new I(J[a],a);a.l()}},5E3);let u=()=>{{var c=d,l=p,k=q;t.clearRect(0,0,g.width,g.height);let [y,K]=w(c,[0,0]),[L,M]=w(c,[g.width,g.height]),[N,O]=w(c,l);for(l=y;l<=L;l++)for(let d=K;d<=M;d++){var e=a.get([l,d]),m=b.get([l,d]);let g={water:m||NaN,terrain:e||NaN};var u=c;u=[l,d].scale(32).sub(u);let [p,q]=u;m=e+m;e=m>e?"hsl(230,80%,"+Math.floor(32+m/255*40)+"%)":240<e?"hsl(0,0%,"+Math.floor(70+(e-240)/15*20)+"%)":220<e?"hsl(35,48%,"+Math.floor(29+
(e-220)/35*-14)+"%)":110<e?"hsl(87,48%,"+Math.floor(40+(e-110)/110*-25)+"%)":"hsl(70,56%,"+Math.floor(55+e/110*-21)+"%)";t.fillStyle=e;t.fillRect(p,q,32,32);k&&l==N&&d==O&&(k.o(g)?(t.fillStyle="rgba(255,255,255,30%)",t.fillRect(p,q,32,32)):(t.strokeStyle="rgba(255,255,255,30%)",t.lineWidth=1,t.strokeRect(p,q,31,31)))}}},y=()=>{a.update().then(()=>console.log(a)).then(u);b.update().then(()=>console.log(a)).then(u);setTimeout(y,1E3)};y();(()=>{c.on("start",()=>{console.log("Started")});c.on("connect",
()=>{console.log("Connected")});c.on("disconnect",()=>{console.log("Disconnected")});c.on("error",()=>{console.log("Oh shit")})})()},!1):module.exports=E();
