'use strict';var d;Array.j=function(...a){return(a[0]||[]).map((b,e)=>a.map((a)=>a[e]))};d=Array.prototype;d.j=function(...a){return Array.j(this,...a)};d.G=function(){return this.reduce((a,b)=>a+b,0)};d.product=function(){return this.reduce((a,b)=>a*b,1)};d.add=function(...a){return this.j(...a).map((a)=>a.G())};d.D=function(){return this.map((a)=>-a)};d.sub=function(a){return this.add(a.D())};d.scale=function(a){return this.map((b)=>b*a)};d.m=function(...a){return Array.m(this,...a)};
d.C=function(){return this.reduce((a,b)=>a.concat(b),[])};Array.m=function(a,...b){return void 0===a?[[]]:a.map((a)=>Array.m(...b).map((b)=>[a,...b])).C()};Array.prototype.w=function(){return Array(Math.ceil(this.length/2)).fill().map((a,b)=>this.slice(2*b,2*b+2))};const k=([a,b],[e,c])=>[a+e,b+c],m=([a,b])=>[-a,-b],n=(a,b)=>b.scale(32).sub(a),p=(a,b)=>b.add(a).scale(.03125).map(Math.floor);function t(a,b,e,c){this.source=a;this.i=b;this.offset=e||[0,0];this.size=c||k(b,m(this.offset))}d=t.prototype;d.keys=function*(){for(let a=0;a<this.size[0];a++)for(let b=0;b<this.size[1];b++)yield[a,b]};function u([a,b],[,e]){return a*e+b}d.get=function(a){if(!(0>a[0]||a[0]>this.size[0]||0>a[1]||a[1]>this.size[1]))return this.source[u(k(a,this.offset),this.i)]};d.set=function(a,b){0>a[0]||a[0]>this.size[0]||0>a[1]||a[1]>this.size[1]||(this.source[u(k(a,this.offset),this.i)]=b)};
d.update=function(a,b){this.set(a,b(this.get(a),a))};d.I=function(a){for(let b of this.keys())this.update(b,a)};d.shift=function(a){return new t(this.source,this.i,k(this.offset,a),k(this.size,m(a)))};d.F=function(a){return new t(this.source,this.i,this.offset,a)};d.window=function(a,b){return this.shift(a).F(b)};d.toJSON=function(){return Array.from(this.keys()).map((a)=>this.get(a))};d.g=function(a){Array.from(this.keys()).j(a).forEach(([a,e])=>this.set(a,e))};function v(a,b){this.coords=a;let {a:e,b:c}=b||{};this.a=e||new t(new Uint8Array(256),[16,16]);this.b=c||new t(new Uint8Array(256),[16,16])}var w=([a,b])=>[Math.floor(a/16),Math.floor(b/16)];v.prototype.A=function(a){return a.sub(this.coords.scale(16))};v.prototype.g=function({terrain:a,water:b}){this.a.g(a);this.b.g(b)};v.prototype.toJSON=function(){return{terrain:this.a.toJSON(),water:this.b.toJSON()}};function x(){this.f={};this.u={};this.s={};this.o=new EventTarget}x.prototype.get=function(a){void 0===this.f[a]&&(this.f[a]=new v(a));1E3<new Date-(this.u[a]||0)&&!(a in this.s)&&(this.s[a]=!0,y(a).then((b)=>this.f[a].g(b)).then(()=>this.u[a]=new Date).then(()=>delete this.s[a]).then(()=>setTimeout(()=>this.get(a),1050)).then(()=>this.dispatchEvent(new Event("update",a))));return this.f[a]};function y(a){return window.fetch(`block/${a[0]}/${a[1]}`).then((a)=>a.json())}
x.prototype.addEventListener=function(...a){this.o.addEventListener(...a)};x.prototype.removeEventListener=function(...a){this.o.removeEventListener(...a)};x.prototype.dispatchEvent=function(...a){this.o.dispatchEvent(...a)};const z=Uint8Array.from("0061736d0100000001170560017d017f6000017c60000060027d7d017d6000017f02190203656e760672616e646f6d000103656e7604706f776600030307060002030204020503010031073805066d656d6f7279020004696e69740003047469636b00050761646472657373000613727573745f65685f706572736f6e616c69747900070a8f11062800200020008e2200931000b65e027f41808080807820008b430000004f5d450d001a2000a80b6a0b9d0303027f027d017c41807e2100024003402000450d01200041818a80016a027f41001000440000000000007040a2220444000000000000f0416320044400000000000000006671450d001a2004ab0b3a0000200041016a21000c000b000b41002100024003402000418080c000460d0120004180086a027f4100200041ff0771b22202430000003e942000410a76b22203430000003e941004430000003f92433333333f942002430000c041952003430000c041951004430000803f92436666e63f94922002430000803c942003430000803c941004430000803f9243cdcc4c3f949243abaa2a42942202430000804f5d200243000000006071450d001a2002a90b3a0000200041016a21000c000b000b418080402100024003402000450d01200041808880016a027f41002000418088c0006a2d00002201410a6a41ff0171b32001417d6a41ff0171b32202931000b69420029222024300007f4320024300007f435d1b2202430000000020024300000000601b2202430000804f5d200243000000006071450d001a2002a90b3a0000200041016a21000c000b000b0bb70502047f067d027f4100430000803f43000000002000200020019243ae67bb3e9422082000928e2206200620082001928e220892438c65583e94220793932200200120082007939322015e22031b2207430000804f5d200743000000006071450d001a2007a90b027f41808080807820068b430000004f5d450d001a2006a80b22026a027f41004300000000430000803f20031b2206430000804f5d200643000000006071450d001a2006a90b027f41808080807820088b430000004f5d450d001a2008a80b22036a41ff017141818880016a2d00006a41ff017141818880016a2d0000410c7021042001200693438c65583e9221062000200793438c65583e922108200143000080bf922107200043000080bf9221092002200341016a41ff017141818880016a2d00006a41016a41ff017141818880016a2d0000410c702105430000003f200020009493200120019493220a43000000005d450440200341ff017141818880016a2d000020026a41ff017141818880016a2d00002102200a4300008040100120002002410c7041036c41828a80016a22022f0000200241026a2d0000411074722202411874411875b29420012002411074411875b2949294210b0b2007438c65d83e9221002009438c65d83e9221014300000000210743000000002109430000003f200820089493200620069493220a43000000005d450440200a430000804010012008200441ff017141036c41828a80016a22022f0000200241026a2d0000411074722202411874411875b29420062002411074411875b294929421090b430000003f200120019493200020009493220643000000005d4504402006430000804010012001200541ff017141036c41828a80016a22022f0000200241026a2d0000411074722202411874411875b29420002002411074411875b294929421070b200b2009922007924300008c42940b8108020e7f017d02400340200a418008460d01200a410a7422024180f83f71210b20024180086a4180f83f71210c41002109024003402009418008460d01200941ff07712202200c722205418088c0006a210641002101024002402002200b722202418088c0006a22072d0000220320024180086a22022d00002200417d6a41ff01714d0d00200320062d000022042208490d00436f12833a43cdcc4c3d43cdcccc3e2003200041ff01714d22001b220e200820054180086a2d00004d1b200e20001b200320046b41ff0171b3941002210420022d000021000c010b410021040b200941016a2109200041ff017120054180086a22032d000022054b0440200020056b41ff0171b3436f12833a94200441ff0171b394100221010b200941ff07712105200720072d000020046b3a0000200620062d000020046a3a0000200220022d000020016b3a0000200320032d000020016a22013a0000410021040240024020062d000022002001417d6a41ff01714d0d00200020072d00002208220d490d00436f12833a43cdcc4c3d43cdcccc3e2000200141ff01714d22011b220e200d20022d00004d1b200e20011b200020086b41ff0171b3941002210020032d000021010c010b410021000b2005200b722105200141ff017120022d000022084b0440200120086b41ff0171b3436f12833a94200041ff0171b394100221040b200620062d000020006b3a0000200720072d000020006a3a0000200320032d000020046b3a0000200220022d000020046a22013a00002005418088c0006a2106410021040240024020072d000022032001417d6a41ff01714d0d00200320062d000022002208490d00436f12833a43cdcc4c3d43cdcccc3e2003200141ff01714d22011b220e200820054180086a2d00004d1b200e20011b200320006b41ff0171b3941002210020022d000021010c010b410021000b200141ff017120054180086a22032d000022054b0440200120056b41ff0171b3436f12833a94200041ff0171b394100221040b200720072d000020006b3a0000200620062d000020006a3a0000200220022d000020046b3a0000200320032d000020046a22013a0000410021040240024020062d000022002001417d6a41ff01714d0d00200020072d000022052208490d00436f12833a43cdcc4c3d43cdcccc3e2000200141ff01714d22011b220e200820022d00004d1b200e20011b200020056b41ff0171b3941002210020032d000021010c010b410021000b200141ff017120022d000022054b0440200120056b41ff0171b3436f12833a94200041ff0171b394100221040b200620062d000020006b3a0000200720072d000020006a3a0000200320032d000020046b3a0000200220022d000020046a3a00000c000b000b200a41016a210a0c000b000b0b05004180080b0300010b0b2d010041828a80010b24010100ff010001ff00ffff00010001ff00010100ffff00ff00010100ff010001ff00ffff".split("").w().map(([a,
b])=>parseInt(a+b,16)));function A(){var a=new WebAssembly.Module(z);this.h=new WebAssembly.Instance(a,{env:{random:Math.random,log:(a)=>console.log("from rust with love: "+a),logf:(a)=>console.log("from rust with love: "+a),powf:Math.pow}});this.h.exports.init();a=this.h.exports.memory;this.l=this.h.exports.address();console.log("address: "+this.l);this.a=new t(new Uint8Array(a.buffer,this.l,1048576),[1024,1024]);this.b=new t(new Uint8Array(a.buffer,this.l+1048576,1048576),[1024,1024])}A.prototype.H=function(){this.h.exports.tick()};function B(){let a=new A,b=a.a,e=a.b;console.log("creating blocks");let c=new t(Array(4096),[64,64]);c.I((a,[c,f])=>new v([c,f],{a:b.window([16*c,16*f],[16,16]),b:e.window([16*c,16*f],[16,16])}));console.log("done");let l=()=>{let b=new Date;a.H();console.log("tick time: "+(new Date-b));setTimeout(l,1E3)};l();return{io:(a)=>{a.on("disconnect",()=>{console.log("Disconnected: "+a.id)});console.log("Connected: "+a.id)},"block/:col/:row":(a,b)=>{b.json(c.get([parseInt(a.params.col),parseInt(a.params.row)]))}}}
;function C(a,b){this.type=a;this.c=b||{};if("trees"==this.type)for(this.c.v=[],a=0;16>a;a++)this.c.v.push("hsl(104,66%,"+(21+20*Math.random())+"%)")}const D={cloud:(a,b)=>{b=[[0,0,32,10],[23,0,10,32],[0,22,32,10],[0,0,10,32]][b.c.direction||0];a.fillStyle="#CADDE3bb";a.fillRect(...b)},rain:(a)=>{a.fillStyle="#77AEEDbb";a.fillRect(12,12,10,10)},trees:(a,b)=>{b.c.v.forEach((b,c)=>{a.fillStyle=b;a.fillRect(c%4*8,8*Math.floor(c/4),8,8)})}};C.prototype.B=function(a){D[this.type](a,this)};const G=(a,b,e,c,l)=>{a.clearRect(0,0,b.width,b.height);let [r,h]=p(e,[0,0]),[f,q]=p(e,[b.width,b.height]);for(b=r;b<=f;b++)for(let c=h;c<=q;c++){var g=l.get(w([b,c]));let f=g.A([b,c]),h=g.b.get(f);g=g.a.get(f);var [E,F]=n(e,[b,c]);a.fillStyle=h>g?"hsl(230,80%,"+Math.floor(32+h/255*40)+"%)":240<g?"hsl(0,0%,"+Math.floor(70+(g-240)/15*20)+"%)":220<g?"hsl(35,48%,"+Math.floor(29+(g-220)/35*-14)+"%)":110<g?"hsl(87,48%,"+Math.floor(40+(g-110)/110*-25)+"%)":"hsl(70,56%,"+Math.floor(55+g/110*-21)+"%)";a.fillRect(E,
F,32,32)}c.forEach(([[b,c],g])=>{a.save();let [f,h]=n(e,[b,c]);a.translate(f,h);g.B(a);a.restore()})};"undefined"!==eval("typeof window")?window.addEventListener("load",()=>{let a,b=new x,e=[[[12,23],new C("cloud",{direction:2})],[[18,24],new C("cloud",{direction:3})],[[14,24],new C("trees")]];a=io({J:!1,transports:["websocket"]});let c=document.getElementById("c"),l=c.getContext("2d"),r=()=>{c.width=window.innerWidth;c.height=window.innerHeight};window.addEventListener("resize",r);r();let h=[0,0],f=null,q=()=>G(l,c,h,e,b);b.addEventListener("update",()=>window.requestAnimationFrame(q));c.addEventListener("mousedown",
(a)=>f=[a.x,a.y]);c.addEventListener("mouseup",()=>f=null);c.addEventListener("mousemove",(a)=>{if(f){let b=[a.x,a.y].sub(f);h=h.sub(b);f=[a.x,a.y];window.requestAnimationFrame(q);h=h.map((a)=>Math.max(a,0))}});(()=>{a.on("start",()=>{console.log("Started")});a.on("connect",()=>{console.log("Connected")});a.on("disconnect",()=>{console.log("Disconnected")});a.on("error",()=>{console.log("Oh shit")})})();q()},!1):module.exports=B();
